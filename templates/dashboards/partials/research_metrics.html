{% load custom_filters %}
<!-- Research Metrics Dashboard - Sesuai Bab 2 & 3 -->
<div class="row mb-4" style="margin-top: 2rem;">
    <div class="col-md-12">
        <h3 class="section-title mb-4">
            <i class="fas fa-flask me-2"></i>Research Metrics (Bab 2 & 3)
            <span class="badge bg-info ms-2">Comprehensive Analysis</span>
        </h3>
    </div>
</div>

<!-- Metrik 2.1.4.1: Login Frequency & Engagement Trends -->
<div class="row mb-4">
    <div class="col-md-12">
        <h4 class="section-title mb-3">
            <i class="fas fa-sign-in-alt me-2"></i>2.1.4.1 - Login Frequency & Engagement Trends
        </h4>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #17a2b8;">
            <div class="stats-card-icon">
                <i class="fas fa-door-open fa-2x" style="color: #17a2b8;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Total Logins (30 days)</h6>
                    <h2 class="stats-number" style="color: #17a2b8;">
                        {{ analytics.login_frequency.total_logins|default:0 }}
                    </h2>
                    <small class="text-muted">Unique Users: {{ analytics.login_frequency.unique_users|default:0 }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #28a745;">
            <div class="stats-card-icon">
                <i class="fas fa-redo fa-2x" style="color: #28a745;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Avg Logins/User</h6>
                    <h2 class="stats-number" style="color: #28a745;">
                        {{ analytics.login_frequency.avg_logins_per_user|floatformat:1|default:"0.0" }}
                    </h2>
                    <small class="text-muted">Login frequency</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #ffc107;">
            <div class="stats-card-icon">
                <i class="fas fa-clock fa-2x" style="color: #ffc107;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Avg Session Duration</h6>
                    <h2 class="stats-number" style="color: #ffc107;">
                        {{ analytics.login_frequency.avg_session_duration|floatformat:0|default:0 }}s
                    </h2>
                    <small class="text-muted">Time per session</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #6f42c1;">
            <div class="stats-card-icon">
                <i class="fas fa-chart-area fa-2x" style="color: #6f42c1;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Engagement Trend</h6>
                    <h2 class="stats-number" style="color: #6f42c1;">
                        {% if analytics.login_frequency.total_logins > 0 %}
                            <i class="fas fa-arrow-up"></i> Active
                        {% else %}
                            <i class="fas fa-minus"></i> No Data
                        {% endif %}
                    </h2>
                    <small class="text-muted">System usage</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Metrik 2.1.4.2: Adaptation Effectiveness (Before vs After) -->
<div class="row mb-4">
    <div class="col-md-12">
        <h4 class="section-title mb-3">
            <i class="fas fa-exchange-alt me-2"></i>2.1.4.2 - Adaptation Effectiveness (Before vs After)
        </h4>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #007bff;">
            <div class="stats-card-icon">
                <i class="fas fa-sync-alt fa-2x" style="color: #007bff;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Total Adaptations</h6>
                    <h2 class="stats-number" style="color: #007bff;">
                        {{ analytics.adaptation_effectiveness.total_adaptations|default:0 }}
                    </h2>
                    <small class="text-muted">System adjustments</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #28a745;">
            <div class="stats-card-icon">
                <i class="fas fa-arrow-up fa-2x" style="color: #28a745;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Success Rate Î”</h6>
                    <h2 class="stats-number" style="color: #28a745;">
                        {{ analytics.adaptation_effectiveness.avg_success_rate_improvement|floatformat:1|default:"0.0" }}%
                    </h2>
                    <small class="text-muted">Average improvement</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #17a2b8;">
            <div class="stats-card-icon">
                <i class="fas fa-tachometer-alt fa-2x" style="color: #17a2b8;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Time Efficiency Î”</h6>
                    <h2 class="stats-number" style="color: #17a2b8;">
                        {{ analytics.adaptation_effectiveness.avg_time_efficiency_improvement|floatformat:1|default:"0.0" }}%
                    </h2>
                    <small class="text-muted">Speed improvement</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #ffc107;">
            <div class="stats-card-icon">
                <i class="fas fa-play-circle fa-2x" style="color: #ffc107;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Continuation Rate</h6>
                    <h2 class="stats-number" style="color: #ffc107;">
                        {{ analytics.adaptation_effectiveness.continuation_rate|floatformat:1|default:"0.0" }}%
                    </h2>
                    <small class="text-muted">Users continue after adaptation</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Adaptation Effectiveness Chart -->
    <div class="col-md-12 mt-3">
        <div class="card enhanced-card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-chart-bar me-2"></i>Adaptation Impact Distribution
                </h6>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="text-center p-3" style="background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                            <h3 class="text-success">{{ analytics.adaptation_effectiveness.positive_adaptations|default:0 }}</h3>
                            <p class="mb-0"><i class="fas fa-thumbs-up me-2"></i>Positive Impact</p>
                            <small class="text-muted">{{ analytics.adaptation_effectiveness.positive_percentage|floatformat:1|default:"0.0" }}%</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3" style="background: rgba(255, 193, 7, 0.1); border-radius: 8px;">
                            <h3 class="text-warning">{{ analytics.adaptation_effectiveness.neutral_adaptations|default:0 }}</h3>
                            <p class="mb-0"><i class="fas fa-minus me-2"></i>Neutral Impact</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3" style="background: rgba(220, 53, 69, 0.1); border-radius: 8px;">
                            <h3 class="text-danger">{{ analytics.adaptation_effectiveness.negative_adaptations|default:0 }}</h3>
                            <p class="mb-0"><i class="fas fa-thumbs-down me-2"></i>Negative Impact</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Metrik 2.1.4.3: Survey & Feedback (Response to Adaptation) -->
<div class="row mb-4">
    <div class="col-md-12">
        <h4 class="section-title mb-3">
            <i class="fas fa-comments me-2"></i>2.1.4.3 - Survey & User Feedback
        </h4>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #e83e8c;">
            <div class="stats-card-icon">
                <i class="fas fa-poll fa-2x" style="color: #e83e8c;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Survey Responses</h6>
                    <h2 class="stats-number" style="color: #e83e8c;">
                        {{ analytics.survey_feedback.total_responses|default:0 }}
                    </h2>
                    <small class="text-muted">Total feedback</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #28a745;">
            <div class="stats-card-icon">
                <i class="fas fa-smile fa-2x" style="color: #28a745;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Avg Satisfaction</h6>
                    <h2 class="stats-number" style="color: #28a745;">
                        {{ analytics.survey_feedback.avg_satisfaction|floatformat:1|default:"0.0" }}/5
                    </h2>
                    <small class="text-muted">User satisfaction rating</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #17a2b8;">
            <div class="stats-card-icon">
                <i class="fas fa-check-circle fa-2x" style="color: #17a2b8;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Would Continue</h6>
                    <h2 class="stats-number" style="color: #17a2b8;">
                        {{ analytics.survey_feedback.would_continue_percentage|floatformat:1|default:"0.0" }}%
                    </h2>
                    <small class="text-muted">Retention indicator</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #ffc107;">
            <div class="stats-card-icon">
                <i class="fas fa-thumbs-up fa-2x" style="color: #ffc107;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Adaptation Helpful</h6>
                    <h2 class="stats-number" style="color: #ffc107;">
                        {{ analytics.survey_feedback.adaptation_helpful_percentage|floatformat:1|default:"0.0" }}%
                    </h2>
                    <small class="text-muted">Found adaptations useful</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Feedback -->
    {% if analytics.survey_feedback.recent_feedback %}
    <div class="col-md-12 mt-3">
        <div class="card enhanced-card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-comment-dots me-2"></i>Recent User Feedback
                </h6>
                <div class="table-responsive mt-3">
                    <table class="table table-enhanced">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Rating</th>
                                <th>Feedback</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for feedback in analytics.survey_feedback.recent_feedback %}
                            <tr>
                                <td>{{ feedback.user }}</td>
                                <td>
                                    <span class="badge bg-{% if feedback.rating >= 4 %}success{% elif feedback.rating == 3 %}warning{% else %}danger{% endif %}">
                                        {{ feedback.rating }}/5
                                    </span>
                                </td>
                                <td>{{ feedback.feedback }}</td>
                                <td><small>{{ feedback.timestamp }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Metrik 2.1.4.4: Q-Learning Evolution & Decision Making -->
<div class="row mb-4">
    <div class="col-md-12">
        <h4 class="section-title mb-3">
            <i class="fas fa-brain me-2"></i>2.1.4.4 - Q-Learning Evolution & Decision Making
        </h4>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #6610f2;">
            <div class="stats-card-icon">
                <i class="fas fa-robot fa-2x" style="color: #6610f2;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Total Decisions</h6>
                    <h2 class="stats-number" style="color: #6610f2;">
                        {{ analytics.qlearning_evolution.total_decisions|default:0 }}
                    </h2>
                    <small class="text-muted">AI decisions made</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #fd7e14;">
            <div class="stats-card-icon">
                <i class="fas fa-search fa-2x" style="color: #fd7e14;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Exploration Rate</h6>
                    <h2 class="stats-number" style="color: #fd7e14;">
                        {{ analytics.qlearning_evolution.exploration_rate|floatformat:1|default:"0.0" }}%
                    </h2>
                    <small class="text-muted">Random exploration</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #20c997;">
            <div class="stats-card-icon">
                <i class="fas fa-bullseye fa-2x" style="color: #20c997;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Exploitation Rate</h6>
                    <h2 class="stats-number" style="color: #20c997;">
                        {{ analytics.qlearning_evolution.exploitation_rate|floatformat:1|default:"0.0" }}%
                    </h2>
                    <small class="text-muted">Best action chosen</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card enhanced-card" style="border-left-color: #28a745;">
            <div class="stats-card-icon">
                <i class="fas fa-star fa-2x" style="color: #28a745;"></i>
            </div>
            <div class="card-body">
                <div class="stats-content">
                    <h6 class="card-title">Optimal Action Rate</h6>
                    <h2 class="stats-number" style="color: #28a745;">
                        {{ analytics.qlearning_evolution.optimal_action_rate|floatformat:1|default:"0.0" }}%
                    </h2>
                    <small class="text-muted">Optimal decisions</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Q-Value Evolution Chart -->
    {% if analytics.qlearning_evolution.q_value_trend %}
    <div class="col-md-12 mt-3">
        <div class="card enhanced-card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-chart-line me-2"></i>Q-Value Evolution Over Time
                </h6>
                <canvas id="qValueTrendChart" height="80"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Bab 3.1.1: State Distribution (Student Levels) -->
<div class="row mb-4">
    <div class="col-md-12">
        <h4 class="section-title mb-3">
            <i class="fas fa-layer-group me-2"></i>Bab 3.1.1 - State Distribution (Student Levels)
        </h4>
    </div>
    
    <div class="col-md-12">
        <div class="card enhanced-card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-users me-2"></i>Student Distribution Across States
                </h6>
                <div class="row mt-3">
                    {% for state, count in analytics.state_distribution.state_distribution.items %}
                    <div class="col-md-3 mb-3">
                        <div class="text-center p-3" style="background: rgba(108, 117, 125, 0.1); border-radius: 8px;">
                            <h3 class="text-primary">{{ count }}</h3>
                            <p class="mb-1"><strong>{{ state }}</strong></p>
                            <small class="text-muted">
                                {{ analytics.state_distribution.state_percentages|get_item:state|floatformat:1 }}% of total
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <canvas id="stateDistributionChart" height="60"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Charts: Difficulty Distribution & User Comparison -->
<div class="row mb-4">
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card enhanced-card h-100">
            <div class="card-body">
                <h6 class="card-title mb-3">
                    <i class="fas fa-chart-pie me-2"></i>Question Difficulty Distribution
                </h6>
                <div style="position: relative; height: 250px;">
                    <canvas id="difficultyPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card enhanced-card h-100">
            <div class="card-body">
                <h6 class="card-title mb-3">
                    <i class="fas fa-chart-bar me-2"></i>Top 10 Users by Success Rate
                </h6>
                <div style="position: relative; height: 250px;">
                    <canvas id="userComparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Q-Learning Logs Table -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card enhanced-card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-table me-2"></i>Q-Learning Decision Logs
                    <span class="badge bg-secondary ms-2">Latest 50</span>
                </h6>
                
                <!-- Search & Filter -->
                <div class="row g-2 mb-3">
                    <div class="col-12 col-md-4">
                        <input type="text" id="qlogSearch" class="form-control form-control-sm" placeholder="ðŸ” Search user, state, action...">
                    </div>
                    <div class="col-6 col-md-3">
                        <select id="qlogFilterDecision" class="form-select form-select-sm">
                            <option value="">All Decision Types</option>
                            <option value="exploration">Exploration</option>
                            <option value="exploitation">Exploitation</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <select id="qlogFilterOptimal" class="form-select form-select-sm">
                            <option value="">All Actions</option>
                            <option value="true">Optimal Only</option>
                            <option value="false">Non-Optimal Only</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-2">
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetQLogFilters()">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-enhanced table-hover table-sm" id="qlearningLogTable">
                        <thead class="sticky-top" style="background: var(--card-bg); z-index: 10;">
                            <tr>
                                <th style="min-width: 100px;">User</th>
                                <th style="min-width: 100px;">State</th>
                                <th style="min-width: 80px;">Action</th>
                                <th style="min-width: 120px;">Decision Type</th>
                                <th style="min-width: 80px;">Q-Value</th>
                                <th style="min-width: 80px;">Best Q</th>
                                <th style="min-width: 80px;">Optimal?</th>
                                <th style="min-width: 80px;">Epsilon</th>
                                <th style="min-width: 150px;">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="qlogTableBody">
                            <!-- Will be populated by JavaScript -->
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0 text-muted">Loading Q-Learning logs...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3 text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="loadMoreQLogs()" id="loadMoreBtn">
                        <i class="fas fa-chevron-down"></i> Load More
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

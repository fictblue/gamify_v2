{% extends 'base.html' %}
{% load static %}

{% block title %}Quiz System - {{ current_level|title }} Level{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'quizzes/css/quiz_styles.css' %}">
<link rel="stylesheet" href="{% static 'quizzes/css/bento_grid.css' %}">
{% endblock %}

{% block content %}
<div class="quiz-container">
    <div class="bento-grid">
    <!-- Level Header Section -->
    <div class="bento-item span-12">
            <div class="quiz-card">
        <div class="card-body text-center">
            <span class="level-badge mb-3">
                <i class="fas fa-trophy"></i>
                {{ current_level|upper }}
            </span>
            <h1 class="display-5 fw-bold mb-3">{{ current_level|title }} Level</h1>
            <p class="lead text-muted">Keep practicing to progress to the next level!</p>
        </div>
    </div>
    </div> <!-- Close bento-item -->

    <!-- Main Content -->
    <section class="quiz-content">
        <div class="container-fluid">
            <div class="bento-item span-12">
            <!-- Level Up Notification -->
            {% if can_level_up %}
                <div class="card-notification level-up-card">
                    <div class="notification-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="notification-content">
                        <h3>Ready to Level Up!</h3>
                        <p>You can advance to <strong>{{ target_level|title }}</strong> level</p>
                    </div>
                    <button class="btn-claim-level" onclick="claimLevelUp()">
                        <i class="fas fa-rocket"></i>Claim Level Up
                    </button>
                </div>
            {% endif %}

            <!-- Level Down Warning -->
            {% if should_level_down %}
                <div class="card-notification level-down-card">
                    <div class="notification-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="notification-content">
                        <h3>Performance Notice</h3>
                        <p>Consider returning to <strong>{{ target_down|title }}</strong> level for better practice</p>
                    </div>
                </div>
            {% endif %}
            </div> <!-- Close bento-item -->

            <div class="bento-item span-12">
                <div class="card-section">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> Available Question Types</h2>
                    <p>Select a difficulty level or let the system choose for you</p>
                </div>
                <div class="difficulty-grid">
                    {% for difficulty_info in difficulty_info_list %}
                        <div class="difficulty-card" data-difficulty="{{ difficulty_info.name }}">
                            <div class="card-background difficulty-{{ difficulty_info.name }}"></div>
                            <div class="card-inner">
                                <div class="difficulty-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <h3 class="difficulty-title">{{ difficulty_info.title }}</h3>
                                <div class="question-count">{{ difficulty_info.count }}</div>
                                <p class="question-label">questions available</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Level Progress Section -->
            {% if level_progress.can_level_up %}
                <div class="bento-item span-6">
                    <div class="card-section">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-line"></i> Progress to {{ target_level|title }}</h2>
                    </div>
                    <div class="progress-content">
                        <div class="progress-stats">
                            <div class="stat-block">
                                <p class="stat-label">Correct Answers</p>
                                <p class="stat-value">{{ level_progress.current_correct }}/{{ level_progress.required_correct }}</p>
                            </div>
                            <div class="progress-bar-wrapper">
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill" style="width: {{ level_progress.progress_percentage }}%">
                                        <span class="progress-text">{{ level_progress.progress_percentage|floatformat:0 }}%</span>
                                    </div>
                                </div>
                                <p class="progress-hint">{{ level_progress.remaining_correct }} more correct answers needed</p>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Statistics Section -->
            <div class="bento-item span-6">
                <div class="card-section">
                <div class="section-header">
                    <h2><i class="fas fa-chart-bar"></i> Your Statistics</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon attempts">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="stat-info">
                            <p class="stat-label">Total Attempts</p>
                            <p class="stat-number">{{ user_stats.total_attempts }}</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon correct">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <p class="stat-label">Correct Answers</p>
                            <p class="stat-number">{{ user_stats.correct_attempts }}</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon accuracy">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-info">
                            <p class="stat-label">Overall Accuracy</p>
                            <p class="stat-number">{{ user_stats.overall_accuracy|floatformat:1 }}%</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon streak">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-info">
                            <p class="stat-label">Current Streak</p>
                            <p class="stat-number">{{ user_stats.current_streak }}</p>
                        </div>
                    </div>
                </div>
            </div>
            </div> <!-- Close bento-item -->

            <!-- Call to Action Section -->
            <div class="bento-item span-12">
                <div class="card-section cta-section">
                <div class="cta-inner">
                    <div class="cta-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                    <div class="cta-text">
                        <h2>Ready to Start?</h2>
                        <p>The system will automatically select appropriate questions for your level. Let's go!</p>
                    </div>
                    <div class="cta-actions">
                        <button class="btn btn-primary" onclick="startQuiz()">
                            <i class="fas fa-play"></i>Start Quiz Session
                        </button>
                        <a href="{% url 'dashboards:student_dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Loading Modal -->
    <div class="modal-overlay" id="quizModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-spinner fa-spin"></i> Loading Question...</h3>
            </div>
            <div class="modal-body">
                <div class="spinner"></div>
                <p>Getting your next question...</p>
                <small>The AI is analyzing your progress</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function startQuiz() {
        const modal = document.getElementById('quizModal');
        modal.classList.add('show');

        fetch('{% url "quizzes:get_next_question" %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/quizzes/student/take/${data.question.id}/`;
            } else {
                alert('Error: ' + (data.error || 'Could not load question'));
                modal.classList.remove('show');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred. Please try again.');
            modal.classList.remove('show');
        });
    }

    function claimLevelUp() {
        if (confirm('Are you sure you want to level up? This will reset your XP but unlock harder questions!')) {
            fetch('{% url "qlearning:claim_level" %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('Error: ' + (data.error || 'Could not level up'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error occurred. Please try again.');
            });
        }
    }

    function showNotification(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Add smooth scroll behavior
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Add keyboard support for difficulty cards
        document.querySelectorAll('.difficulty-card').forEach(card => {
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    startQuiz();
                }
            });
        });
    });
</script>
{% endblock %}
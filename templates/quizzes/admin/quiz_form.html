{% extends 'base.html' %}
{% load static %}
{% block title %}{% if is_edit %}Edit{% else %}Create{% endif %} Question - Admin{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'quizzes/css/admin_quiz_form_styles.css' %}">
{% endblock %}

{% block content %}
<div class="container quiz-form-container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Breadcrumb Navigation -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'dashboards:admin_dashboard' %}" class="text-decoration-none">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'quizzes:admin_quiz_list' %}" class="text-decoration-none">
                            <i class="fas fa-list me-1"></i>Questions
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        {% if is_edit %}Edit{% else %}Create{% endif %} Question
                    </li>
                </ol>
            </nav>

            <!-- Form Card -->
            <div class="gamify-card fade-in">
                <div class="card-header text-center">
                    <h2 class="mb-2">
                        <i class="fas fa-{% if is_edit %}edit{% else %}plus{% endif %} text-white me-2"></i>
                        {% if is_edit %}Edit{% else %}Create{% endif %} Question
                    </h2>
                    <p class="mb-0 text-white-50">Build engaging questions for the gamification system</p>
                </div>
                <div class="card-body">
                    <form method="post" id="questionForm" novalidate>
                        {% csrf_token %}

                        <!-- Question Content Section -->
                        <div class="form-section mb-4">
                            <div class="section-header mb-3">
                                <h5 class="section-title">
                                    <i class="fas fa-file-alt text-primary me-2"></i>Question Content
                                </h5>
                                <p class="section-subtitle text-muted">Define the main question details</p>
                            </div>

                            <div class="mb-4">
                                <label for="text" class="form-label">
                                    <i class="fas fa-question text-primary me-2"></i>Question Text *
                                </label>
                                <textarea
                                    class="form-control question-textarea"
                                    id="text"
                                    name="text"
                                    rows="4"
                                    required
                                    placeholder="Enter your question here..."
                                >{% if is_edit %}{{ question.text }}{% endif %}</textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>Make sure your question is clear and concise
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="difficulty" class="form-label">
                                            <i class="fas fa-chart-line text-primary me-2"></i>Difficulty Level *
                                        </label>
                                        <select class="form-select modern-select" id="difficulty" name="difficulty" required>
                                            {% for value, label in DIFFICULTY_CHOICES %}
                                                <option value="{{ value }}"
                                                        {% if is_edit and question.difficulty == value %}selected{% endif %}>
                                                    {{ label }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="format" class="form-label">
                                            <i class="fas fa-list-ol text-primary me-2"></i>Question Format *
                                        </label>
                                        <select class="form-select modern-select" id="format" name="format" required>
                                            {% for value, label in FORMAT_CHOICES %}
                                                <option value="{{ value }}"
                                                        {% if is_edit and question.format == value %}selected{% endif %}>
                                                    {{ label }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="curriculum_tag" class="form-label">
                                    <i class="fas fa-tag text-primary me-2"></i>Curriculum Tag
                                </label>
                                <input type="text"
                                       class="form-control modern-input"
                                       id="curriculum_tag"
                                       name="curriculum_tag"
                                       value="{% if is_edit %}{{ question.curriculum_tag }}{% endif %}"
                                       placeholder="e.g., Mathematics, Science, History...">
                                <div class="form-text">
                                    <i class="fas fa-lightbulb me-1"></i>Optional: Helps categorize questions by subject
                                </div>
                            </div>
                        </div>

                        <!-- Answer Configuration Section -->
                        <div class="form-section mb-4">
                            <div class="section-header mb-3">
                                <h5 class="section-title">
                                    <i class="fas fa-key text-success me-2"></i>Answer Configuration
                                </h5>
                                <p class="section-subtitle text-muted">Set up the correct answers and options</p>
                            </div>

                            <!-- Options (JSON) - Only show for MCQ formats -->
                            <div id="optionsSection" style="{% if is_edit and question.format == 'short_answer' %}display: none;{% endif %}">
                                <div class="mb-4">
                                    <label for="options" class="form-label">
                                        <i class="fas fa-list text-success me-2"></i>Answer Options (JSON Format)
                                    </label>
                                    <textarea
                                        class="form-control json-editor modern-textarea"
                                        id="options"
                                        name="options"
                                        rows="5"
                                        placeholder='{"A": "First option", "B": "Second option", "C": "Third option", "D": "Fourth option"}'
                                    >{% if is_edit %}{{ options_str }}{% endif %}</textarea>
                                    <div class="form-text">
                                        <i class="fas fa-code me-1"></i>For multiple choice questions, enter options as JSON.
                                        Example: <code>{"A": "Option 1", "B": "Option 2"}</code>
                                    </div>
                                </div>

                                <!-- Preview Options -->
                                <div id="optionsPreview" class="options-preview mb-3">
                                    <small class="preview-label">
                                        <i class="fas fa-eye me-1"></i>Options Preview:
                                    </small>
                                    <div id="optionsPreviewContent" class="preview-content"></div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="answer_key" class="form-label">
                                    <i class="fas fa-key text-success me-2"></i>Correct Answer *
                                </label>
                                <textarea
                                    class="form-control modern-textarea"
                                    id="answer_key"
                                    name="answer_key"
                                    rows="3"
                                    required
                                    placeholder="{% if is_edit and question.format == 'short_answer' %}Enter the exact correct answer text...{% else %}Enter correct answer(s) as JSON format...{% endif %}"
                                >{% if is_edit %}{{ question.answer_key }}{% endif %}</textarea>
                                <div class="form-text">
                                    {% if is_edit and question.format == 'short_answer' %}
                                        <i class="fas fa-font me-1"></i>Enter the exact text that should be considered correct (case-sensitive).
                                    {% else %}
                                        <i class="fas fa-code me-1"></i>For MCQ: Enter as <code>"A"</code> or <code>["A", "B"]</code> for multiple correct answers.
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="explanation" class="form-label">
                                    <i class="fas fa-info-circle text-info me-2"></i>Explanation
                                </label>
                                <textarea
                                    class="form-control modern-textarea"
                                    id="explanation"
                                    name="explanation"
                                    rows="4"
                                    placeholder="Provide a detailed explanation for why this is the correct answer..."
                                >{% if is_edit %}{{ question.explanation }}{% endif %}</textarea>
                                <div class="form-text">
                                    <i class="fas fa-graduation-cap me-1"></i>Help students learn by explaining the reasoning behind the correct answer
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <div class="row">
                                <div class="col-md-6">
                                    <a href="{% url 'quizzes:admin_quiz_list' %}" class="btn btn-cancel w-100">
                                        <i class="fas fa-arrow-left me-2"></i>Back to Questions
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <button type="submit" class="btn btn-submit w-100">
                                        <span class="btn-text">
                                            <i class="fas fa-save me-2"></i>
                                            {% if is_edit %}Update{% else %}Create{% endif %} Question
                                        </span>
                                        <span class="btn-loading" style="display: none;">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Processing...
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


    <script>
        // Show/hide options section based on format
        document.getElementById('format').addEventListener('change', function() {
            const optionsSection = document.getElementById('optionsSection');
            const answerKeyField = document.getElementById('answer_key');

            if (this.value === 'short_answer') {
                optionsSection.style.display = 'none';
                answerKeyField.placeholder = 'Enter the correct answer text...';
            } else {
                optionsSection.style.display = 'block';
                answerKeyField.placeholder = 'Enter correct answer(s) as JSON...';
            }
            updateOptionsPreview();
        });

        // Update options preview
        function updateOptionsPreview() {
            const optionsTextarea = document.getElementById('options');
            const previewDiv = document.getElementById('optionsPreviewContent');

            try {
                const options = JSON.parse(optionsTextarea.value);
                let previewHtml = '';

                for (const [key, value] of Object.entries(options)) {
                    previewHtml += `<span class="badge bg-light text-dark option-badge">${key}: ${value}</span>`;
                }

                previewDiv.innerHTML = previewHtml || '<em class="text-muted">No options defined</em>';
            } catch (e) {
                previewDiv.innerHTML = '<em class="text-muted">Invalid JSON format</em>';
            }
        }

        // Update preview on input
        document.getElementById('options').addEventListener('input', updateOptionsPreview);

        // Initialize preview on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateOptionsPreview();
        });
    </script>
</body>
</html>
